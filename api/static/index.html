<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metadata Search</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232733;
    --border: #2e3345;
    --text: #e1e4ed;
    --text2: #8b90a0;
    --accent: #6c7bf7;
    --accent-hover: #8490ff;
    --tag-bg: #2a2d4a;
    --green: #4ade80;
    --orange: #fb923c;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  header {
    text-align: center;
    margin-bottom: 2rem;
  }

  header h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: .25rem; }
  header p { color: var(--text2); font-size: .85rem; }

  /* Mode tabs */
  .mode-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 1rem;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .mode-tab {
    flex: 1;
    padding: .7rem 1rem;
    text-align: center;
    background: var(--surface);
    color: var(--text2);
    font-size: .9rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all .2s;
  }

  .mode-tab:not(:last-child) { border-right: 1px solid var(--border); }
  .mode-tab:hover { color: var(--text); background: var(--surface2); }
  .mode-tab.active { background: var(--accent); color: #fff; }

  /* Search box */
  .search-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
  }

  .search-row {
    display: flex;
    gap: .75rem;
    margin-bottom: 1rem;
  }

  .search-row input[type="text"] {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: .65rem 1rem;
    color: var(--text);
    font-size: .95rem;
    outline: none;
    transition: border-color .2s;
  }

  .search-row input[type="text"]:focus { border-color: var(--accent); }

  .search-row button {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: .65rem 1.5rem;
    font-size: .95rem;
    font-weight: 500;
    cursor: pointer;
    transition: background .2s;
    white-space: nowrap;
  }

  .search-row button:hover { background: var(--accent-hover); }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  .control-group label {
    font-size: .8rem;
    color: var(--text2);
    white-space: nowrap;
  }

  .control-group select,
  .control-group input[type="number"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: .4rem .6rem;
    color: var(--text);
    font-size: .85rem;
    outline: none;
  }

  .control-group input[type="number"] { width: 60px; }
  .control-group select { min-width: 100px; }

  .btn-list {
    margin-left: auto;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: .4rem .8rem;
    color: var(--text2);
    font-size: .8rem;
    cursor: pointer;
    transition: all .2s;
  }

  .btn-list:hover { border-color: var(--accent); color: var(--text); }

  /* Facets */
  .facets-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1rem;
  }

  .facets-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: .75rem;
  }

  .facets-header h3 {
    font-size: .85rem;
    font-weight: 600;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: .5px;
  }

  .facets-clear {
    font-size: .78rem;
    color: var(--accent);
    cursor: pointer;
    border: none;
    background: none;
    padding: .2rem .5rem;
    border-radius: 4px;
    transition: background .2s;
  }

  .facets-clear:hover { background: var(--tag-bg); }

  .facet-groups { display: flex; flex-wrap: wrap; gap: 1.25rem; }

  .facet-group { min-width: 150px; }

  .facet-group-title {
    font-size: .78rem;
    color: var(--text2);
    margin-bottom: .4rem;
    font-weight: 500;
  }

  .facet-chips { display: flex; flex-wrap: wrap; gap: .35rem; }

  .facet-chip {
    display: inline-flex;
    align-items: center;
    gap: .3rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: .25rem .6rem;
    font-size: .78rem;
    color: var(--text2);
    cursor: pointer;
    transition: all .15s;
    user-select: none;
  }

  .facet-chip:hover { border-color: var(--accent); color: var(--text); }

  .facet-chip.active {
    background: var(--tag-bg);
    border-color: var(--accent);
    color: var(--accent);
  }

  .facet-chip .facet-count {
    background: var(--border);
    padding: .05rem .35rem;
    border-radius: 4px;
    font-size: .7rem;
    font-weight: 600;
  }

  .facet-chip.active .facet-count { background: var(--accent); color: #fff; }

  .active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: .35rem;
    margin-top: .75rem;
    padding-top: .75rem;
    border-top: 1px solid var(--border);
  }

  .active-filter-tag {
    display: inline-flex;
    align-items: center;
    gap: .3rem;
    background: var(--accent);
    color: #fff;
    border-radius: 5px;
    padding: .2rem .5rem;
    font-size: .75rem;
    font-weight: 500;
  }

  .active-filter-tag .remove-filter {
    cursor: pointer;
    font-weight: 700;
    margin-left: .15rem;
    opacity: .8;
  }

  .active-filter-tag .remove-filter:hover { opacity: 1; }

  /* Filter bar */
  .filter-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: .75rem 1.25rem;
    margin-bottom: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
  }

  .filter-bar .result-count {
    font-size: .85rem;
    color: var(--text2);
    margin-right: auto;
  }

  .filter-bar .result-count strong { color: var(--text); }

  /* Results */
  .results { display: flex; flex-direction: column; gap: .75rem; }

  .scene-card, .content-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem 1.25rem;
    transition: border-color .2s;
  }

  .scene-card:hover, .content-card:hover { border-color: var(--accent); }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: .5rem;
    gap: 1rem;
  }

  .card-header .video-title { font-weight: 600; font-size: .95rem; }

  .card-header .score {
    background: var(--tag-bg);
    color: var(--accent);
    font-size: .75rem;
    font-weight: 600;
    padding: .2rem .6rem;
    border-radius: 6px;
    white-space: nowrap;
  }

  .scene-desc, .content-desc {
    color: var(--text2);
    font-size: .88rem;
    line-height: 1.5;
    margin-bottom: .6rem;
  }

  .content-desc {
    max-height: 4.5em;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }

  .card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    align-items: center;
    font-size: .78rem;
    color: var(--text2);
  }

  .meta-tag { background: var(--tag-bg); padding: .15rem .5rem; border-radius: 4px; }
  .meta-time { color: var(--green); }
  .meta-duration { color: var(--green); }
  .meta-date { color: var(--orange); }
  .meta-sep { color: var(--border); }
  .meta-category { color: var(--accent); font-weight: 500; }
  .meta-author { color: #c084fc; }

  /* States */
  .empty-state { text-align: center; color: var(--text2); padding: 3rem 1rem; font-size: .9rem; }
  .loading { text-align: center; padding: 2rem; color: var(--text2); }

  .spinner {
    display: inline-block;
    width: 24px; height: 24px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin .6s linear infinite;
    margin-bottom: .5rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg {
    background: #2d1b1b;
    border: 1px solid #5c2a2a;
    color: #f87171;
    padding: .75rem 1rem;
    border-radius: 8px;
    font-size: .85rem;
    margin-bottom: 1rem;
  }

  @media (max-width: 600px) {
    .search-row { flex-direction: column; }
    .controls { flex-direction: column; align-items: flex-start; }
    .btn-list { margin-left: 0; }
    .filter-bar { flex-direction: column; align-items: flex-start; }
    .facet-groups { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Metadata Search</h1>
    <p>Video search — scene &amp; content</p>
  </header>

  <div class="mode-tabs">
    <button class="mode-tab active" data-mode="scene">Scene (Phan canh)</button>
    <button class="mode-tab" data-mode="content">Content (Video)</button>
  </div>

  <div class="search-box">
    <div class="search-row">
      <input type="text" id="queryInput" placeholder="Nhap noi dung tim kiem..." autofocus>
      <button id="searchBtn">Tim kiem</button>
    </div>
    <div class="controls">
      <div class="control-group">
        <label>Phuong thuc:</label>
        <select id="searchType">
          <option value="hybrid">Hybrid</option>
          <option value="semantic">Semantic</option>
          <option value="fulltext">Fulltext (BM25)</option>
        </select>
      </div>
      <div class="control-group">
        <label>Top-K:</label>
        <input type="number" id="topK" value="10" min="1" max="100">
      </div>
      <button class="btn-list" id="listBtn">Danh sach</button>
    </div>
  </div>

  <div class="facets-panel" id="facetsPanel" style="display:none;">
    <div class="facets-header">
      <h3>Bo loc</h3>
      <button class="facets-clear" id="clearFilters" style="display:none;">Xoa bo loc</button>
    </div>
    <div class="facet-groups" id="facetGroups"></div>
    <div class="active-filters" id="activeFilters" style="display:none;"></div>
  </div>

  <div class="filter-bar" id="filterBar" style="display:none;">
    <div class="result-count">
      <strong id="resultCount">0</strong> ket qua
    </div>
    <div class="control-group">
      <label>Sap xep:</label>
      <select id="sortBy">
        <option value="relevance">Do lien quan</option>
        <option value="date_desc">Ngay (moi nhat)</option>
        <option value="date_asc">Ngay (cu nhat)</option>
      </select>
    </div>
  </div>

  <div id="status"></div>
  <div class="results" id="results">
    <div class="empty-state">Nhap tu khoa va nhan "Tim kiem" de bat dau.</div>
  </div>
</div>

<script>
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);
const API_BASE = window.location.origin;

let currentMode = 'scene'; // 'scene' or 'content'
let allHits = [];
let allFacets = null;
let activeFilters = {};
let lastQuery = '';

// Mode tabs
$$('.mode-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.mode-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentMode = tab.dataset.mode;
    // Reset state
    allHits = [];
    allFacets = null;
    activeFilters = {};
    $('#facetsPanel').style.display = 'none';
    $('#filterBar').style.display = 'none';
    $('#status').innerHTML = '';
    $('#results').innerHTML = '<div class="empty-state">Nhap tu khoa va nhan "Tim kiem" de bat dau.</div>';
  });
});

$('#queryInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') doSearch();
});
$('#searchBtn').addEventListener('click', doSearch);
$('#sortBy').addEventListener('change', renderHits);
$('#clearFilters').addEventListener('click', clearAllFilters);
$('#listBtn').addEventListener('click', doList);

async function doSearch() {
  const query = $('#queryInput').value.trim();
  if (!query) return;

  lastQuery = query;
  activeFilters = {};

  const type = $('#searchType').value;
  const k = parseInt($('#topK').value) || 10;

  const resultsEl = $('#results');
  const statusEl = $('#status');
  statusEl.innerHTML = '';
  resultsEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>Dang tim kiem...</div></div>';

  try {
    const params = new URLSearchParams({ query_text: query, k: k });
    const endpoint = `${API_BASE}/v1/search/${currentMode}/${type}?${params}`;
    const resp = await fetch(endpoint);

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.detail || `HTTP ${resp.status}`);
    }

    const data = await resp.json();
    allHits = data.hits || [];
    allFacets = data.facets || null;

    $('#filterBar').style.display = 'flex';
    $('#sortBy').value = 'relevance';

    renderFacets();
    renderHits();
  } catch (e) {
    resultsEl.innerHTML = '';
    statusEl.innerHTML = `<div class="error-msg">${esc(e.message)}</div>`;
    $('#filterBar').style.display = 'none';
    $('#facetsPanel').style.display = 'none';
  }
}

async function doList() {
  const resultsEl = $('#results');
  const statusEl = $('#status');
  statusEl.innerHTML = '';
  resultsEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>Dang tai danh sach...</div></div>';
  $('#facetsPanel').style.display = 'none';

  try {
    const endpoint = `${API_BASE}/v1/search/${currentMode}/list?limit=100`;
    const resp = await fetch(endpoint);

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.detail || `HTTP ${resp.status}`);
    }

    const data = await resp.json();
    const items = data.items || [];

    $('#filterBar').style.display = 'flex';
    $('#resultCount').textContent = items.length;

    if (items.length === 0) {
      resultsEl.innerHTML = '<div class="empty-state">Chua co du lieu nao trong he thong.</div>';
      return;
    }

    if (currentMode === 'scene') {
      allHits = items.map(r => ({...r, score: 0}));
      renderHits();
    } else {
      allHits = items.map(r => ({...r, score: 0}));
      renderHits();
    }
  } catch (e) {
    resultsEl.innerHTML = '';
    statusEl.innerHTML = `<div class="error-msg">${esc(e.message)}</div>`;
    $('#filterBar').style.display = 'none';
  }
}

async function doFilterSearch() {
  const sceneIds = getFilteredIds();
  if (!sceneIds || sceneIds.length === 0) return;

  const k = parseInt($('#topK').value) || 10;
  const resultsEl = $('#results');
  const statusEl = $('#status');
  statusEl.innerHTML = '';
  resultsEl.innerHTML = '<div class="loading"><div class="spinner"></div><div>Dang loc...</div></div>';

  try {
    const resp = await fetch(`${API_BASE}/v1/search/scene/filter`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query_text: lastQuery, scene_ids: sceneIds, k: k }),
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.detail || `HTTP ${resp.status}`);
    }

    const data = await resp.json();
    allHits = data.hits || [];
    renderHits();
  } catch (e) {
    resultsEl.innerHTML = '';
    statusEl.innerHTML = `<div class="error-msg">${esc(e.message)}</div>`;
  }
}

function getFilteredIds() {
  const keys = Object.keys(activeFilters);
  if (keys.length === 0) return null;

  let result = null;
  for (const key of keys) {
    const ids = new Set(activeFilters[key].ids);
    if (result === null) {
      result = ids;
    } else {
      result = new Set([...result].filter(id => ids.has(id)));
    }
  }
  return result ? [...result] : [];
}

const FACET_LABELS = {
  category: 'Danh muc',
  created_date: 'Ngay tao',
  author: 'Tac gia',
};

function renderFacets() {
  const panel = $('#facetsPanel');
  const groupsEl = $('#facetGroups');

  if (!allFacets) { panel.style.display = 'none'; return; }

  const facetKeys = currentMode === 'scene'
    ? ['category', 'created_date', 'author']
    : ['category', 'author'];
  const hasFacets = facetKeys.some(k => allFacets[k] && allFacets[k].length > 0);

  if (!hasFacets) { panel.style.display = 'none'; return; }

  panel.style.display = 'block';

  let html = '';
  for (const key of facetKeys) {
    const items = allFacets[key] || [];
    if (items.length === 0) continue;

    html += `<div class="facet-group">
      <div class="facet-group-title">${FACET_LABELS[key] || key}</div>
      <div class="facet-chips">`;

    for (const item of items) {
      const idKey = item.scene_ids ? 'scene_ids' : 'content_ids';
      const ids = item[idKey] || [];
      const isActive = activeFilters[key] && activeFilters[key].value === item.value;
      html += `<div class="facet-chip ${isActive ? 'active' : ''}"
        data-field="${key}" data-value="${esc(item.value)}"
        data-ids='${JSON.stringify(ids)}'>
        ${esc(item.value)} <span class="facet-count">${item.count}</span>
      </div>`;
    }

    html += `</div></div>`;
  }

  groupsEl.innerHTML = html;
  groupsEl.querySelectorAll('.facet-chip').forEach(chip => {
    chip.addEventListener('click', () => toggleFacet(chip));
  });
  renderActiveFilters();
}

function toggleFacet(chip) {
  const field = chip.dataset.field;
  const value = chip.dataset.value;
  const ids = JSON.parse(chip.dataset.ids);

  if (activeFilters[field] && activeFilters[field].value === value) {
    delete activeFilters[field];
  } else {
    activeFilters[field] = { value, ids };
  }

  $('#facetGroups').querySelectorAll('.facet-chip').forEach(c => {
    const f = c.dataset.field;
    const v = c.dataset.value;
    c.classList.toggle('active', activeFilters[f] && activeFilters[f].value === v);
  });

  renderActiveFilters();

  if (currentMode === 'scene' && Object.keys(activeFilters).length > 0) {
    doFilterSearch();
  } else if (Object.keys(activeFilters).length === 0) {
    doSearch();
  }
}

function renderActiveFilters() {
  const el = $('#activeFilters');
  const clearBtn = $('#clearFilters');
  const keys = Object.keys(activeFilters);

  if (keys.length === 0) {
    el.style.display = 'none';
    clearBtn.style.display = 'none';
    return;
  }

  clearBtn.style.display = 'inline-block';
  el.style.display = 'flex';
  el.innerHTML = keys.map(key =>
    `<span class="active-filter-tag">
      ${FACET_LABELS[key] || key}: ${esc(activeFilters[key].value)}
      <span class="remove-filter" data-field="${key}">&times;</span>
    </span>`
  ).join('');

  el.querySelectorAll('.remove-filter').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const field = btn.dataset.field;
      delete activeFilters[field];
      $('#facetGroups').querySelectorAll('.facet-chip').forEach(c => {
        if (c.dataset.field === field) c.classList.remove('active');
      });
      renderActiveFilters();
      if (Object.keys(activeFilters).length > 0) {
        doFilterSearch();
      } else {
        doSearch();
      }
    });
  });
}

function clearAllFilters() {
  activeFilters = {};
  $('#facetGroups').querySelectorAll('.facet-chip').forEach(c => c.classList.remove('active'));
  renderActiveFilters();
  doSearch();
}

function renderHits() {
  const resultsEl = $('#results');
  let hits = [...allHits];

  const sortBy = $('#sortBy').value;
  if (currentMode === 'scene') {
    if (sortBy === 'date_desc') hits.sort((a, b) => (b.created_date || '').localeCompare(a.created_date || ''));
    else if (sortBy === 'date_asc') hits.sort((a, b) => (a.created_date || '').localeCompare(b.created_date || ''));
  } else {
    if (sortBy === 'date_desc') hits.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
    else if (sortBy === 'date_asc') hits.sort((a, b) => (a.created_at || '').localeCompare(b.created_at || ''));
  }

  $('#resultCount').textContent = hits.length;

  if (hits.length === 0) {
    resultsEl.innerHTML = '<div class="empty-state">Khong tim thay ket qua phu hop.</div>';
    return;
  }

  if (currentMode === 'scene') {
    resultsEl.innerHTML = hits.map(h => renderSceneCard(h)).join('');
  } else {
    resultsEl.innerHTML = hits.map(h => renderContentCard(h)).join('');
  }
}

function renderSceneCard(h) {
  const timeRange = formatTime(h.start_time_sec) + ' — ' + formatTime(h.end_time_sec);
  const tags = (h.video_tags || []).map(t => `<span class="meta-tag">${esc(t)}</span>`).join('');
  const date = h.created_date || '';
  const scoreHtml = h.score ? `<div class="score">${h.score.toFixed(4)}</div>` : '';

  return `
    <div class="scene-card">
      <div class="card-header">
        <div class="video-title">${esc(h.video_title)}</div>
        ${scoreHtml}
      </div>
      <div class="scene-desc">${esc(h.scene_description)}</div>
      <div class="card-meta">
        <span class="meta-time">${timeRange}</span>
        ${h.category ? `<span class="meta-sep">|</span><span class="meta-category">${esc(h.category)}</span>` : ''}
        ${h.author ? `<span class="meta-sep">|</span><span class="meta-author">${esc(h.author)}</span>` : ''}
        ${date ? `<span class="meta-sep">|</span><span class="meta-date">${date}</span>` : ''}
        ${tags ? `<span class="meta-sep">|</span>${tags}` : ''}
      </div>
    </div>
  `;
}

function renderContentCard(h) {
  const tags = (h.tags || []).map(t => `<span class="meta-tag">${esc(t)}</span>`).join('');
  const duration = h.duration_sec ? formatDuration(h.duration_sec) : '';
  const scoreHtml = h.score ? `<div class="score">${h.score.toFixed(4)}</div>` : '';

  return `
    <div class="content-card">
      <div class="card-header">
        <div class="video-title">${esc(h.title)}</div>
        ${scoreHtml}
      </div>
      <div class="content-desc">${esc(h.description)}</div>
      <div class="card-meta">
        ${duration ? `<span class="meta-duration">${duration}</span>` : ''}
        ${h.category ? `<span class="meta-sep">|</span><span class="meta-category">${esc(h.category)}</span>` : ''}
        ${h.author ? `<span class="meta-sep">|</span><span class="meta-author">${esc(h.author)}</span>` : ''}
        ${h.created_at ? `<span class="meta-sep">|</span><span class="meta-date">${h.created_at}</span>` : ''}
        ${tags ? `<span class="meta-sep">|</span>${tags}` : ''}
      </div>
    </div>
  `;
}

function formatTime(sec) {
  if (sec == null) return '--:--';
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${s.toString().padStart(2, '0')}`;
}

function formatDuration(sec) {
  if (!sec) return '';
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = Math.floor(sec % 60);
  if (h > 0) return `${h}h${m.toString().padStart(2,'0')}m`;
  return `${m}m${s.toString().padStart(2,'0')}s`;
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
